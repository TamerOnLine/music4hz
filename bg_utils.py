"""
bg_utils.py â€” Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙˆÙ„ÙŠØ¯ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ©
"""

import numpy as np

# ðŸŽ¯ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¹ÙŠÙ†Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (Hz)
SR = 44100


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ“Œ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¶ÙˆØ¶Ø§Ø¡ ÙˆØ§Ù„Ù…ÙˆØ¬Ø§Øª Ø§Ù„Ø¨Ø·ÙŠØ¦Ø©
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def pinkish(white: np.ndarray) -> np.ndarray:
    """
    ØªØ­ÙˆÙŠÙ„ Ø¶ÙˆØ¶Ø§Ø¡ Ø¨ÙŠØ¶Ø§Ø¡ Ø¥Ù„Ù‰ Ø¶ÙˆØ¶Ø§Ø¡ ÙˆØ±Ø¯ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© ÙÙ„ØªØ± Ø¨Ø³ÙŠØ·Ø©.
    white: Ù…ØµÙÙˆÙØ© Ø¶ÙˆØ¶Ø§Ø¡ Ø¨ÙŠØ¶Ø§Ø¡ (float32)
    """
    b = np.zeros(7, dtype=np.float32)
    pink = np.zeros_like(white)
    for i, w in enumerate(white):
        b[0] = 0.99886 * b[0] + w * 0.0555179
        b[1] = 0.99332 * b[1] + w * 0.0750759
        b[2] = 0.96900 * b[2] + w * 0.1538520
        b[3] = 0.86650 * b[3] + w * 0.3104856
        b[4] = 0.55000 * b[4] + w * 0.5329522
        b[5] = -0.7616 * b[5] - w * 0.0168980
        pink[i] = b[0] + b[1] + b[2] + b[3] + b[4] + b[5] + b[6] + w * 0.5362
        b[6] = w * 0.115926
    return pink.astype(np.float32)


def lfo_sine(n: int, f: float) -> np.ndarray:
    """
    ØªÙˆÙ„ÙŠØ¯ Ù…ÙˆØ¬Ø© LFO Ø¬ÙŠØ¨ÙŠØ©.
    n: Ø¹Ø¯Ø¯ Ø§Ù„Ø¹ÙŠÙ†Ø§Øª
    f: ØªØ±Ø¯Ø¯ LFO (Hz)
    """
    t = np.arange(n, dtype=np.float32) / np.float32(SR)
    return np.sin(2 * np.pi * np.float32(f) * t)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ“Œ ÙÙ„Ø§ØªØ± Ø¨Ø³ÙŠØ·Ø©
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def one_pole_lowpass(x: np.ndarray, cutoff: float) -> np.ndarray:
    """
    ÙÙ„ØªØ± Low-Pass Ù…Ù† Ø±ØªØ¨Ø© Ø£ÙˆÙ„Ù‰.
    cutoff: Ø§Ù„ØªØ±Ø¯Ø¯ Ø§Ù„Ù‚Ø§Ø·Ø¹ (Hz)
    """
    a = np.exp(-2 * np.pi * cutoff / SR)
    y = np.zeros_like(x)
    y[0] = x[0]
    for i in range(1, len(x)):
        y[i] = (1 - a) * x[i] + a * y[i - 1]
    return y.astype(np.float32)


def one_pole_highpass(x: np.ndarray, cutoff: float) -> np.ndarray:
    """
    ÙÙ„ØªØ± High-Pass Ù…Ù† Ø±ØªØ¨Ø© Ø£ÙˆÙ„Ù‰.
    cutoff: Ø§Ù„ØªØ±Ø¯Ø¯ Ø§Ù„Ù‚Ø§Ø·Ø¹ (Hz)
    """
    a = np.exp(-2 * np.pi * cutoff / SR)
    y = np.zeros_like(x)
    y[0] = x[0]
    for i in range(1, len(x)):
        y[i] = a * (y[i - 1] + x[i] - x[i - 1])
    return y.astype(np.float32)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ“Œ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø³ØªÙŠØ±ÙŠÙˆ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def stereo_normalize(x: np.ndarray, target_level: float = 0.2) -> np.ndarray:
    """
    Ù…ÙˆØ§Ø²Ù†Ø© Ù…Ø³ØªÙˆÙ‰ Ø¥Ø´Ø§Ø±Ø© Ø³ØªÙŠØ±ÙŠÙˆ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ target_level.
    """
    peak = np.max(np.abs(x))
    if peak == 0:
        return x
    return (x / peak * target_level).astype(np.float32)
